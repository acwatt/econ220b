---
title: "Econ 220B PS 2"
author: "AC Watt"
email: aaron@acwatt.net
date: "2021-12-03"
output:
  pdf_document:
    toc: true
    toc_depth: 2
header-includes:
   - \usepackage{dcolumn}
   - \usepackage{amsmath}
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
   - \usepackage{float}
   - \floatstyle{plaintop}
   - \restylefloat{table}
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'Econ_220b_PS2_acWatt_2021.pdf')) })
---

```{r setup, message=F, echo=F}
rm(list=ls())
knitr::opts_chunk$set(echo = F)
```
<!--
R version 3.6.3 (2020-02-29)
Purpose of script: run code necessary for ps2b for ARE 213

Notes: Need to open ps2b.Rmd from the ps2b folder (without Rstudio being started first)
if Rstudio is already started, the working directory will not be set
to the ps2b/ folder

\usepackage{dcolumn}: dcolumn is needed in latex compilation for multicolumn tables
-->

```{r Settings}
# stargazer table type (html, latex, or text)
# Change to latex when outputting to PDF, html when outputting to html
table_type = "latex"
Cache = TRUE

```




```{r packages, message=F, warning=F}
# Packages
library(stargazer)
library(ggplot2)
library(readxl)
library(tidyverse)
library(lubridate)
library(kableExtra)
```



\newpage
<!--=========================================================================-->
# Part a
<!--=========================================================================-->
**Construct sample statistics similar to Tabel IIa and IIb on page 1003.**
\vspace{1em}


```{r Table IIa, eval=T, cache=Cache, message=F, warning=F, results='asis'}
# Load top 11 rows only to get replacement dates and mileage
f = 'rust_data_clean.xlsx'
headers = read_excel(f, sheet='header_names', col_names='header')
sheets = excel_sheets(f)[1:8]

get_headers = function(f, sheets, i) {
    # Return dataframe of transformed i'th sheet
    read_excel(f, sheet=sheets[i], n_max=11, col_names=F, col_types="numeric") %>%
    t() %>%
    data.frame(stringsAsFactors = F) %>%
    mutate(sheet = sheets[i], 
           group = i)
}

# Initialize dataframe
replacement_dates = get_headers(f, sheets, 1)

# Fill dataframe with other sheets
for (i in 2:8) {
    df_ = get_headers(f, sheets, i)
    replacement_dates = rbind(replacement_dates, df_)
}

# Pivot dataframe and create variables
replacement_dates = replacement_dates %>%
    rename(!!set_names(paste0("X", 1:11), str_replace_all(headers$header, " ", "_"))) %>%
    mutate(purchase_date = ymd(str_c(purchase_year, purchase_month, "-01")),
           replace_date1 = ymd(str_c(engine_replacement_1_year, engine_replacement_1_month, "-01")),
           replace_date2 = ymd(str_c(engine_replacement_2_year, engine_replacement_2_month, "-01")),
           pivot_months_to_replace1 = interval(purchase_date, replace_date1) %/% months(1) + 1,
           pivot_months_to_replace2 = interval(replace_date1, replace_date2) %/% months(1) + 1,
           pivot_replace_mileage1 = ifelse(engine_replacement_1_odometer_reading == 0, NA,
                                           engine_replacement_1_odometer_reading),
           pivot_replace_mileage2 = ifelse(engine_replacement_2_odometer_reading == 0, NA, 
                                           engine_replacement_2_odometer_reading - engine_replacement_1_odometer_reading),
           initial_odometer_reading_date = ymd(str_c(initial_odometer_reading_year, initial_odometer_reading_month, "-01"))) %>%
    select(bus_number, purchase_date, replace_date1, pivot_months_to_replace1, replace_date2, pivot_months_to_replace2, everything())

# Make Table IIa
replacement_dates %>%
    pivot_longer(starts_with("pivot_"),
                 names_to = c(".value", "replacement"),
                 names_pattern = "pivot_(.*)(.)",
                 values_drop_na = T
    ) %>%
    mutate(group = as.character(group)) %>%
    bind_rows(mutate(., group = "Full Sample")) %>%
    group_by(group) %>%
    summarize(max_mileage = max(replace_mileage, na.rm=T),
              min_mileage = min(replace_mileage, na.rm=T),
              mean_mileage = as.integer(mean(replace_mileage, na.rm=T)),
              sd_mileage = as.integer(sd(replace_mileage, na.rm=T)),
              max_months = max(months_to_replace, na.rm=T),
              min_months = min(months_to_replace, na.rm=T),
              mean_months = mean(months_to_replace, na.rm=T),
              sd_months = sd(months_to_replace, na.rm=T),
              n = n()) %>% 
    complete(group = c(as.character(1:8), "Full Sample")) %>%
    mutate(across(everything(), ~replace_na(.x, 0))) %>%
    kbl(caption = "Summary of Replacement Data (Subsample of buses for which at least 1 replacement occurred)",
        col.names = c('Bus Group', 'Max', 'Min', 'Mean', 'Standard Deviation',
                      'Max', 'Min', 'Mean', 'Standard Deviation', 'Number of Observations'),
        align = 'cc', digits = 1, booktabs = T, format.args = list(big.mark = ",")
    ) %>%
    kable_styling(latex_options = "HOLD_position") %>%
    column_spec(1, width = "1.5cm") %>%
    column_spec(c(2:4, 6:8), width = "1cm") %>%
    column_spec(c(5, 9), width = "1.5cm") %>%
    column_spec(10, width = "2cm") %>%
    add_header_above(c(" " = 1, "Mileage at Replacement" = 4, "Elapsed Time (Months)" = 4, " " = 1)) %>%
    row_spec(8, hline_after = T)
    
```



```{r Table IIb, eval=T, cache=Cache, message=F, warning=F, results='asis'}
# Load rest of data below row 11 to get mileage readings
f = 'rust_data_clean.xlsx'
sheets = excel_sheets(f)[1:8]

get_data = function(f, sheet_) {
    # Return transformed dataframe from sheet
    read_excel(f, sheet=sheet_, skip=11,
               col_names=paste0('bus_', filter(replacement_dates, sheet==sheet_)$bus_number), 
               col_types="numeric") %>%
        mutate(sheet = sheet_, 
               m = row_number()) %>%
        pivot_longer(starts_with("bus_"),
                     names_to = "bus_number",
                     names_prefix = 'bus_') %>%
        mutate(bus_number = as.numeric(bus_number)) %>%
        rename(c('mileage' = 'value'))
}

# Initialize dataframe
data = get_data(f, sheets[1])

# Get rest of sheets
for (i in 2:8) {
    df_ = get_data(f, sheets[i])
    data = rbind(data, df_)
}

# Join on variables from headers and create new variables
data = data %>%
    arrange(sheet, bus_number) %>%
    left_join(replacement_dates %>% select(bus_number,
                                           initial_odometer_reading_date, 
                                           replace_date1, 
                                           replace_date2,
                                           group),
              by = 'bus_number') %>%
    mutate(date = initial_odometer_reading_date + months(m - 1),
           group = as.character(group),
           replaced = ifelse((date == replace_date1 & !is.na(replace_date1)) | (date == replace_date2 & !is.na(replace_date2)), 1, 0))

# Make Table IIa
data %>%
    filter(is.na(replace_date1)) %>%
    arrange(date) %>%
    group_by(group) %>%
    filter(date == last(date), .by_group = TRUE) %>%
    bind_rows(mutate(., group = "Full Sample")) %>%
    summarize(max_mileage = max(mileage, na.rm=T),
              min_mileage = min(mileage, na.rm=T),
              mean_mileage = as.integer(mean(mileage, na.rm=T)),
              sd_mileage = as.integer(sd(mileage, na.rm=T)),
              max_months = max(m, na.rm=T),
              min_months = min(m, na.rm=T),
              mean_months = mean(m, na.rm=T),
              sd_months = sd(m, na.rm=T),
              n = n()) %>% 
    complete(group = c(as.character(1:8), "Full Sample")) %>%
    mutate(across(everything(), ~replace_na(.x, 0))) %>%
    kbl(caption = "Summary of Censored Data (subsample of buses for which no replacements occurred)",
        col.names = c('Bus Group', 'Max', 'Min', 'Mean', 'Standard Deviation',
                      'Max', 'Min', 'Mean', 'Standard Deviation', 'Number of Observations'),
        align = 'cc', digits = 1, booktabs = T, format.args = list(big.mark = ",")
    ) %>%
    kable_styling(latex_options = "HOLD_position") %>%
    column_spec(1, width = "1.5cm") %>%
    column_spec(c(2:4, 6:8), width = "1cm") %>%
    column_spec(c(5, 9), width = "1.5cm") %>%
    column_spec(10, width = "2cm") %>%
    add_header_above(c(" " = 1, "Mileage at May 1, 1985" = 4, "Elapsed Time (Months)" = 4, " " = 1)) %>%
    row_spec(8, hline_after = T)
    
```





\newpage
<!--=========================================================================-->
# Part b
<!--=========================================================================-->
**Estimate his model using a two-step procedure. Please briefly document your
estimation procedure in words. Create a table similar to the first five columns
of Table IX on page 1021. If you forward simulate the value function, see
Pakes Pollard (1989) for reference on how to draw errors and compute confidence
intervals.**

















\newpage
<!--=========================================================================-->
# Part c
<!--=========================================================================-->
**Estimate his model using a nested fixed point procedure. Create a table
similar to the first five columns of Table IX on page 1021.**

Steps:

1. Break the mileage into 5,000 mile bins

2. Create g-bins of 0, 1, and 2 for mileage in the intervals [0, 5000), [5000, 10,000) and [10,000, +$\infty$).


```{r Discretize the mileage}
# Create 5,000 mile bins
data = data %>%
    mutate(mileage5000 = cut(mileage,
                             breaks = seq(0, max(data$mileage)+5000, by=5000),
                             labels = F)) %>%
    # Create g-bins
    mutate(gbin = case_when(mileage >= 0 & mileage < 5000 ~ 0,
                            mileage >=5000 & mileage < 10000 ~ 1,
                            TRUE ~ 2))

```

3. Define the cost functions to be estimated

```{r cost functions}
# Polynomial
c1 = function(x, theta1) theta1[1]*x + theta1[2]*x^2 + theta1[3]*x^3
# exponential
c2 = function(x, theta1) theta1[1]*exp(theta1[2]*x)
# hyperbolic
c3 = function(x, theta1) theta1[1]/(91-x)
# square root
c3 = function(x, theta1) theta1[1]*x^0.5

```

4. Merge replacements into the data

```{r}

```




5. Estimate $\theta_3$ using Maximum Likelihood

```{r}
# Transition probability
transition_p = function(x, x_last, i_last, theta3) {
    if (x == x_last) {
        return 
    }
}
# Define the l1 likelihood function for theta3
likelihood1 = function()
```











\newpage
# Appendix A: R Code

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```





















